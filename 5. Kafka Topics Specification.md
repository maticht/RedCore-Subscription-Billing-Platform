# 1. Overview

Все асинхронные события в платформе проходят через **Apache Kafka**.  
Каждый топик имеет строго определённое назначение, отправителя и потребителей, что обеспечивает:
- event-driven архитектуру
- независимость сервисов (decoupling)
- надёжные ретраи
- горизонтальное масштабирование через consumer groups

# 2. Topics List
## 2.1 События подписок

### 2.1.1 `subscriptions.created`
Создание подписки  
**Produced by:** Subscription Service  
**Triggered by API:** `POST /subscriptions`
**Consumed by:** Payment Service
### 2.1.2 `subscriptions.updated`
Обновление подписки  
**Produced by:** Subscription Service  
**Triggered by API:** `PUT /subscriptions/{id}`
**Consumed by:** Analytics Service
### 2.1.3 `subscriptions.cancelled`
Отмена подписки  
**Produced by:** Subscription Service  
**Triggered by API:** `DELETE /subscriptions/{id}`
**Consumed by:** Payment Service
### 2.1.4 `subscriptions.renew_required`
Автопродление подписки  
**Produced by:** Retry Service  
**Triggered by:** cron, scheduler
**Consumed by:** Subscription Service

## 2.2 События платежей

### 2.2.1 `payments.requested`
Запрос на платёж вручную  
**Produced by:** API Gateway, Admin UI  
**Triggered by API:** `POST /payments`
**Consumed by:** Payment Service
### 2.2.2 `payments.retry.requested`
Запрос ручного retry  
**Produced by:** API Gateway  
**Triggered by API:** `POST /payments/{id}/retry`
**Consumed by:** Retry Service
### 2.2.3 `payments.failed`
Платёж не удался  
**Produced by:** Payment Service, Webhook Handler
**Consumed by:** Retry Service
### 2.2.4 `payments.completed`
Платёж успешно завершён  
**Produced by:** Payment Service  
**Triggered by:** 
- Асинхронное продление подписки 
- Webhook от провайдера 
- Ручной retry 
**NOT triggered by:** Синхронное создание подписки
**Consumed by:** Subscription Service

## 2.3 События Webhook-ов провайдеров

### 2.3.1 `webhooks.received`
Получен внешний webhook  
**Produced by:** Webhook Handler  
**Triggered by API:** `POST /webhooks/{provider}`
**Consumed by:** Payment Service

# 3. General Guidelines
- Все сообщения идемпотентные
- Формат сообщений — JSON схема фиксирована
- Retention на топики — ≥ 7 дней
- Partition key:
    - `subscription_id` — для событий подписок
    - `customer_id` — для уведомлений
- Все сервисы должны использовать **Consumer Groups** для масштабирования и отказоустойчивости