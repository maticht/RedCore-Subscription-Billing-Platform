# 1. VISION

## 1.1 Цель продукта
Создать масштабируемую платформу подписочного биллинга, обеспечивающую полный жизненный цикл подписок, автоматические продления, оплату, возвраты и интеграцию с внешними платёжными провайдерами. Платформа должна выдерживать высокую нагрузку и обеспечивать стабильную и предсказуемую работу для B2C и B2B клиентов.

## 1.2 Целевая аудитория
- B2C клиенты - конечные пользователи, оформляющие подписки
- B2B партнёры - используют REST API для управления подписками своих клиентов
- Администраторы - управляют тарифами, пользователями, отчётами и операциями
- Интеграторы / провайдеры - подключают свои системы оплаты

## 1.3 Описание проблемы
Многие компании испытывают сложности с созданием и поддержкой полноценного подписочного биллинга: автоматические списания, обработка сбоев, триалы, возвраты, корректная работа с несколькими провайдерами и высокая нагрузка требуют дорогостоящей инфраструктуры и экспертизы.

## 1.4 Высокоуровневое видение решения
Платформа представляет собой единый центр управления подписками и платежами и включает:
- REST API для B2B интеграций
- Встроенные адаптеры внешних платёжных систем
- Интерфейс для клиентов (Customer Portal)
- Интерфейс для администраторов (Admin Portal)
- Систему мониторинга, логирования и оповещений
- Высоконагруженную и отказоустойчивую архитектуру

## 1.5 Стратегические цели
- Унифицировать интеграцию с платёжными провайдерами
- Обеспечить стабильную работу сервиса при нагрузке >1000 RPS
- Сократить количество ошибок продления и ручных операций
- Обеспечить прозрачность событий платежей через логи и метрики
- Уменьшить время добавления нового провайдера до 2 недель

## 1.6 Ключевые функции
- Управление жизненным циклом подписки
- Поддержка различных тарифных планов и триалов
- Автоматические продления
- Повторы неудачных платежей
- Маршрутизация платежей (Smart Routing) в зависимости от валюты или региона
- Возвраты
- Приём и обработка вебхуков
- UI кабинеты
- Мониторинг, логирование, нотификации
- Интеграция внешних платёжных систем

## 1.7 Критерии успеха
- Есть запас прочности для масштабирования до 1000 RPS
- Среднее время ответа API < 300 мс
- SLA системы - 99.9%
- Уровень ошибок продлений < 0.1%
- Интеграция нового провайдера - ≤ 2 недели
- 90% операций выполняются пользователями самостоятельно без поддержки

# 2. SCOPE

## 2.1 В рамках проекта
- Управление подписками: создание, обновление, продление, приостановка, отмена
- Управление платежами: списания, повторные попытки, возвраты
- Управление тарифными планами
- Интеграция с внешними платёжными системами
- Приём и обработка вебхуков
- Кабинет клиента и Кабинет администратора
- Логирование (структурированные логи)
- Мониторинг (метрики, алерты, дашборды)
- Система авторизации и ролей (OAuth2 + RBAC)
- Хранилища данных: PostgreSQL, Redis, S3
- Брокер сообщений: для асинхронная обработки событий, очередей retry и оптимизации нагрузки

## 2.2 Вне рамок проекта
- Налоговый учёт и бухгалтерия
- Продвинутые маркетинговые функции
- Система уведомлений пользователя
- Fraud detection
- BI-аналитика
- Генерация юридически значимых документов

## 2.3 Ограничения
- Ограничение по времени обработки вебхуков - до 3 секунд.
- Необходимость соответствия PCI DSS
- Форматы вебхуков зависят от провайдера
- Все операции должны быть идемпотентными

## 2.4 Допущения
- Все провайдеры используют вебхуки
- Бэкенд взаимодействует через REST API
- Платформа развёрнута в облачной среде
- Модель разделения данных по клиентам (multi-tenant)
- Курсы валют обновляются внешним источником или фиксируются на стороне платежного провайдера

[Use Case.drawio.png](https://github.com/maticht/RedCore-Subscription-Billing-Platform/blob/main/imgs/Use%20Case.drawio.png)
# 3. ВЫСОКОУРОВНЕВАЯ АРХИТЕКТУРА

## 3.1 Архитектурные принципы
- Микросервисная архитектура
- Асинхронная обработка событий через брокер сообщений
- Горизонтальное масштабирование
- Идемпотентность операций
- API-first подход

## 3.2 Компоненты архитектуры (упрощённо)
Входящие запросы идут через API Gateway, бизнес-логика разделена по сервисам, а асинхронные процессы (ретраи, вебхуки) обрабатываются отдельными компонентами
- API Gateway - единая точка входа в систему
- Auth Service - аутентификация и управление ролями (поддержка API Keys)
- Service Подписок - управление жизненным циклом подписок
- Service Платежей - работа со списаниями и возвратами
- Адаптеры Провайдеров - логика интеграции со сторонними системами
- Обработчик Вебхуков - приём внешних событий
- Сервис Повторов (Retry/Scheduler) - обработка неуспешных попыток
- Интерфейсы - Кабинет клиента, Кабинет администратора
- Система хранения данных - PostgreSQL, Redis, S3
- Мониторинг - Prometheus + Grafana
- Логирование - Loki
- Брокер сообщений - Apache Kafka

## 3.3 Пропускная способность
- Поддержка более 1000 запросов в секунду
- Обработка вебхуков: 500–800 событий в секунду
- Очереди ретраев обеспечивают надёжность при пиках нагрузки

# 4. TIMELINE (High-Level Roadmap)

## Этап 1 (0–1 месяц): Базовая инфраструктура
- Проектирование архитектуры
- База авторизации
- Начальная версия сервиса подписок
- Основной API

## Этап 2 (1–2 месяц): Платёжный модуль
- Основной модуль платежей
- Интеграция с PayPal, Stripe и др
- Создание обработчика вебхуков
- Реализация механизма повторных попыток

## Этап 3 (2–3 месяц): Интерфейсы и мониторинг
- Разработка интерфейсов (Кабинет клиента, Кабинет администратора)
- Алерты и метрики
- Дашборды Grafana
- Логирование событий

## Этап 4 (3–4 месяц): Расширение функционала
- Поддержка возвратов
- Подключение дополнительных провайдеров
- Поддержка B2B multi-tenant API
- Настройка уведомлений и алертов для администраторов

## Этап 5 (4–6 месяц): Подготовка к продакшену
- Тестирование под высокими нагрузками при 1000+ RPS
- Автоматическое масштабирование
- Усиление безопасности
- Финальная оптимизация производительности
