# 4.1 Subscriptions API

## 4.1.1 Create Subscription

### POST /subscriptions

Создание новой подписки.
### Request Body

```json
{
  "customer_id": "string",
  "plan_id": "string",
  "payment_method_id": "string",
  "start_date": "2025-11-19",
  "trial_period_days": 14
}
```
### Response (201)

```json
{
  "subscription_id": "string",
  "status": "active | payment_failed",
  "payment": { 
	 "payment_id": "string", 
	 "status": "completed | failed", 
	 "amount": 1000 
  },
  "start_date": "2025-11-19",
  "end_date": "2026-11-19"
}
```
### Produces Kafka Event
- **`subscriptions.created`**

### Error Responses
- `400` - неверный формат запроса
- `402` - платёж отклонён провайдером
- `404` - customer или plan не найден
- `500` - ошибка сервера

## 4.1.2 Get Subscription

### GET /subscriptions/{id}

Получение состояния подписки.  
Без Kafka-событий.
### Response (200)

```json
{
  "subscription_id": "string",
  "customer_id": "string",
  "plan_id": "string",
  "status": "active",
  "start_date": "2025-11-19",
  "end_date": "2026-11-19"
}
```
### Errors
- `404` - подписка не найдена
- `500` - ошибка сервера

## 4.1.3 Update Subscription

### PUT /subscriptions/{id}

Изменение параметров подписки: тариф, даты, настройки.
### Request Body

```json
{
  "plan_id": "string",
  "next_billing_date": "2025-12-01",
  "metadata": {}
}
```
### Response (200)

```json
{
  "subscription_id": "string",
  "updated_at": "2025-11-20T10:00:00Z"
}
```

### Produces Kafka Event
- **`subscriptions.updated`**

### Errors
- `400` - неверный формат запроса
- `404`- подписка не найдена
- `500` - ошибка сервера

## 4.1.4 Cancel Subscription

### DELETE /subscriptions/{id}

Отмена подписки с указанием причины.
### Optional Request Body

```json
{
  "reason": "string"
}
```
### Response (200)

```json
{
  "subscription_id": "string",
  "status": "canceled",
  "canceled_at": "2025-11-20"
}
```

### Produces Kafka Event
- **`subscriptions.cancelled`**

### Errors
- `404` - не найдена
- `409` - уже отменена
- `500` - ошибка сервера

# 4.2 Payments API

## 4.2.1 Manual Payment Request

### POST /payments

Инициировать платёж вручную (например, из UI).
### Request Body

```json
{
  "subscription_id": "string",
  "amount": 1000,
  "payment_method_id": "string",
  "reason": "manual_retry | additional_charge"
}
```
### Response (202)

```json
{
  "payment_id": "string",
  "status": "pending | processing"
}
```
### Produces Kafka Event
- **`payments.requested`**

### Errors

- `400` - неверный формат запроса
- `404` - подписка не найдена
- `500` - ошибка сервера

## 4.2.2 Get Payment

### GET /payments/{id}

Получить текущее состояние платежа.

Без Kafka-событий.
### Response (200)

```json
{
  "payment_id": "string",
  "subscription_id": "string",
  "status": "failed | completed | pending",
  "amount": 1000
}
```
### Errors
- `404`- платеж не найден
- `500` - ошибка сервера

## 4.2.3 Manual Retry

### POST /payments/{id}/retry

Ручной запрос повторной попытки платежа.
### Response (202)

```json
{
  "payment_id": "string",
  "retry": "scheduled"
}
```

### Produces Kafka Event
- **`payments.retry.requested`**
### Errors
- `404`- платеж не найден
- `409` - retry недоступен
- `500` - ошибка сервера

#### 4.2.4 List Payments

### GET /payments`

Получить список всех платежей (счетов) клиента или по подписке.
### Response (200)

```json
{
    "payment_id": "string",
    "status": "completed",
    "amount": 1000,
    "created_at": "2025-10-01T12:00:00Z"
}
```

### Errors
- `400` - неверный формат
- `500` - ошибка сервера
 
# 4.3 Webhooks API

## 4.3.1 Receive External Webhook

### POST /webhooks/{provider}

Получение webhook-а от стороннего провайдера (Stripe, PayPal и др).
### Request Body

```json
{
  "event_type": "payment_succeeded | payment_failed",
  "subscription_id": "string",
  "amount": 1000,
  "currency": "USD",
  "timestamp": "2025-11-19T12:00:00Z",
  "payload": {}
}
```
### Response (200)

```json
{
  "status": "received"
}
```

### Produces Kafka Event
- **`webhooks.received`**

### Errors
- `400` - некорректный payload
- `404` - subscription_id не существует
- `500` - ошибка сервера