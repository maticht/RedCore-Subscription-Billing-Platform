# Product Backlog — Subscription Billing Platform
Версия: 1.1  
Дата: 2025-11-20  

# Epic 1 — Управление подписками (Subscriptions)

## US-1.1 — Создание подписки
**User Story:**  
Я как клиент или партнёр хочу создать подписку на выбранный план, чтобы начать период подписки и запустить платёжный цикл

**Priority:** High
## US-1.2 — Просмотр состояния подписки
**User Story:**  
Я как клиент хочу получить статус своей подписки, чтобы видеть её текущее состояние

**Priority:** High
## US-1.3 — Обновление подписки (смена плана)
**User Story:**  
Я как клиент хочу изменить план подписки, чтобы перейти на другой тариф без отмены текущей подписки

**Priority:** High

# Epic 2 — Платежи и инвойсы

## US-2.1 — Создание инвойса при продлении
**User Story:**  
Я как система хочу автоматически создавать инвойс при продлении, чтобы инициировать новый цикл оплаты

**Priority:** High
## US-2.2 — Инициирование платежа
**User Story:**  
Я как система хочу инициировать оплату инвойса, чтобы списать средства у платёжного провайдера

**Priority:** High
## US-2.3 — Retry платежей
**User Story:**  
Я как система хочу выполнять retry неуспешных платежей, чтобы повысить шанс успешного списания

**Priority:** High
## US-2.4 — Refund
**User Story:**  
Я как клиент хочу получить возврат средств, чтобы компенсировать ошибочный или отменённый платёж

**Priority:** Medium

# Epic 3 — Webhooks и провайдеры

## US-3.1 — Приём вебхуков
**User Story:**  
Я как система хочу принимать вебхуки провайдера, чтобы обновлять состояние платежей

**Priority:** High
## US-3.2 — Обработка payment.succeeded
**User Story:**  
Я как система хочу обрабатывать событие payment.succeeded, чтобы обновлять транзакции и подписки

**Priority:** High

# Epic 4 — API Gateway и Auth

## US-4.1 — Авторизация
**User Story:**  
Я как пользователь хочу авторизовываться через OAuth2/JWT, чтобы безопасно обращаться к API

**Priority:** High
## US-4.2 — Идемпотентность REST
**User Story:**  
Я как клиент хочу, чтобы повторные запросы с Idempotency-Key не создавали дубликатов, чтобы избежать ошибок при сетевых сбоях

**Priority:** High

# Epic 5 — Админ-панель

## US-5.1 — CRUD тарифов
**User Story:**  
Я как админ хочу управлять тарифными планами, чтобы контролировать доступные продукты

**Priority:** Medium
## US-5.2 — Просмотр ошибок и ручной запуск retry
**User Story:**  
Я как админ хочу видеть список неуспешных платежей и иметь возможность вручную запускать retry, чтобы оперативно исправлять ошибки и контролировать платёжный процесс

**Priority:** Medium

**Acceptance Criteria:**
AC-01: Отображение списка failed payments  
Дано: админ находится в админ-панели  
Когда: он открывает раздел "Ошибки платежей"  
Тогда: система отображает список платежей со статусами failed и failed_permanent с колонками payment_id, amount, reason, last_attempt, attempts_count

AC-02: Просмотр деталей платежа  
Дано: админ видит список failed payments  
Когда: он нажимает на конкретный платёж  
Тогда: система отображает карточку платежа с полными данными: subscription_id, invoice_id, provider_response, попытки retry, timestamps

AC-03: Отображение кнопки ручного retry  
Дано: открыт экран карточки платежа со статусом failed  
Когда: админ просматривает детали  
Тогда: система отображает кнопку "Запустить retry"

AC-04: Недоступность ручного retry  
Дано: у платежа статус failed_permanent или attempts_count достиг max_retries  
Когда: админ открывает карточку платежа  
Тогда: кнопка retry не отображается

AC-05: Подтверждение перед запуском retry  
Дано: админ нажал "Запустить retry"  
Когда: система показывает диалог подтверждения  
Тогда: в диалоге отображаются payment_id и предупреждение о возможной повторной попытке списания

AC-06: Выполнение retry  
Дано: админ подтверждает retry  
Когда: он нажимает "Запустить"  
Тогда система:
- создаёт задачу retry в Retry Service  
- публикует событие payments.retry.manual  
- обновляет attempts_count  

AC-07: Обновление статуса в UI  
Дано: retry инициирован  
Когда: система запускает попытку списания  
Тогда: UI отображает статус "retrying..." до получения результата

AC-08: Успешный retry  
Дано: платёж успешно списан  
Когда: Retry Service получает подтверждение  
Тогда система:
- обновляет статус платежа в succeeded  
- публикует событие payments.succeeded  
- отображает администратору уведомление "Платёж успешно проведён"

AC-09: Неуспешный retry  
Дано: retry завершился ошибкой  
Когда: Retry Service возвращает ошибку  
Тогда система:
- увеличивает attempts_count  
- обновляет статус в failed (или failed_permanent при достижении лимита)  
- отображает администратору уведомление с описанием ошибки

AC-10: Логи аудита  
Дано: любой ручной retry инициирован  
Когда: операция завершена  
Тогда: система записывает в журнал: admin_id, payment_id, timestamp, attempt_number, результат операции

AC-11: Ограничение прав доступа  
Дано: пользователь без роли admin пытается открыть раздел ошибок  
Когда: он делает запрос  
Тогда: система возвращает 403 Forbidden
