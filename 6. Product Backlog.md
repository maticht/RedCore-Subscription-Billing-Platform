# Product Backlog — Subscription Billing Platform
Версия: 1.1  
Дата: 2025-11-20  

# Epic 1 — Управление подписками (Subscriptions)

## US-1.1 — Создание подписки
**User Story:**  
Я как клиент или партнёр хочу создать подписку на выбранный план чтобы начать период подписки и запустить платёжный цикл

**Priority:** High

**Acceptance Criteria:**
- Given валидные данные When POST /subscriptions Then создаётся запись и возвращается 201 с subscription_id
- Генерируется событие subscriptions.created
- Если план trial то платёж не инициируется и возвращается trial_end
- При невалидных данных возвращается 4xx

## US-1.2 — Просмотр состояния подписки
**User Story:**  
Я как клиент хочу получить статус своей подписки чтобы видеть её текущее состояние

**Priority:** High

**Acceptance Criteria:**
- Given subscription_id When GET /subscriptions/{id} Then возвращается объект со status и историей платежей
- next_payment содержит корректную дату следующей попытки списания

## US-1.3 — Обновление подписки (смена плана)
**User Story:**  
Я как клиент хочу изменить план подписки чтобы перейти на другой тариф без отмены текущей подписки

**Priority:** High

**Acceptance Criteria:**
- Given активная подписка When PUT /subscriptions/{id} Then план обновлён и отправлено событие subscriptions.updated
- Proration рассчитан по бизнес-правилам

# Epic 2 — Платежи и инвойсы

## US-2.1 — Создание инвойса при продлении
**User Story:**  
Я как система хочу автоматически создавать инвойс при продлении чтобы инициировать новый цикл оплаты

**Priority:** High

**Acceptance Criteria:**
- При продлении создаётся invoice в БД
- Публикуется событие invoices.created
- Invoice содержит amount, currency, subscription_id, due_date

## US-2.2 — Инициирование платежа
**User Story:**  
Я как система хочу инициировать оплату инвойса чтобы списать средства у платёжного провайдера

**Priority:** High

**Acceptance Criteria:**
- Given invoice pending When инициируется платеж Then создаётся событие payments.requested
- При success от провайдера платеж помечается succeeded и создаётся payments.succeeded
- При ошибке создаётся задача retry и payments.failed

## US-2.3 — Retry платежей
**User Story:**  
Я как система хочу выполнять retry неуспешных платежей чтобы повысить шанс успешного списания

**Priority:** High

**Acceptance Criteria:**
- Стратегия retry экспоненциальная и не превышает max_retries
- Каждая попытка публикует payments.retry.requested
- После max_retries статус failed_permanent и уведомление админу

## US-2.4 — Refund
**User Story:**  
Я как клиент хочу получить возврат средств чтобы компенсировать ошибочный или отменённый платёж

**Priority:** Medium

**Acceptance Criteria:**
- POST /payments/{id}/refund создаёт событие payments.refunded
- Partial refund корректно уменьшает amount и фиксируется в истории

# Epic 3 — Webhooks и провайдеры

## US-3.1 — Приём вебхуков
**User Story:**  
Я как система хочу принимать вебхуки провайдера чтобы обновлять состояние платежей

**Priority:** High

**Acceptance Criteria:**
- POST /webhooks/{provider} валидирует подпись
- При валидности публикуется webhooks.received
- Дубликаты обрабатываются идемпотентно

## US-3.2 — Обработка payment.succeeded
**User Story:**  
Я как система хочу обрабатывать событие payment.succeeded чтобы обновлять транзакции и подписки

**Priority:** High

**Acceptance Criteria:**
- Транзакция переводится в succeeded
- Генерируется payments.succeeded
- Статус подписки обновляется
- Время обработки ≤ 3 секунд

# Epic 4 — API Gateway и Auth

## US-4.1 — Авторизация
**User Story:**  
Я как пользователь хочу авторизовываться через OAuth2/JWT чтобы безопасно обращаться к API

**Priority:** High

**Acceptance Criteria:**
- Все защищённые эндпоинты требуют валидный токен
- Ошибки аутентификации → 401
- Ошибки авторизации → 403

## US-4.2 — Идемпотентность REST
**User Story:**  
Я как клиент хочу чтобы повторные запросы с Idempotency-Key не создавали дубликатов чтобы избежать ошибок при сетевых сбоях

**Priority:** High

**Acceptance Criteria:**
- Повторный запрос с тем же ключом не создаёт новую сущность
- Хранение ключа в Redis с TTL

# Epic 5 — Админ-панель

## US-5.1 — CRUD тарифов
**User Story:**  
Я как админ хочу управлять тарифными планами чтобы контролировать доступные продукты

**Priority:** Medium

**Acceptance Criteria:**
- CRUD через UI/API
- Деактивация запрещает новые подписки но не влияет на текущие

## US-5.2 — Просмотр ошибок и retry
**User Story:**  
Я как админ хочу видеть failed payments чтобы вручную запускать retry

**Priority:** Medium

**Acceptance Criteria:**
- Список ошибок
- Кнопка ручного retry

# Epic 6 — Хранилища и резервирование

## US-6.1 — Хранение файлов в S3
**User Story:**  
Я как система хочу хранить чеки и файлы в S3 чтобы обеспечивать доступ и долговременное хранение

**Priority:** Medium

**Acceptance Criteria:**
- Файл записывается в S3
- Возвращается presigned URL

## US-6.2 — Backup PostgreSQL
**User Story:**  
Я как DevOps хочу выполнять резервное копирование БД чтобы обеспечить восстановление после сбоев

**Priority:** Medium

**Acceptance Criteria:**
- Периодические бэкапы в S3
- Процесс восстановления документирован и протестирован

# Epic 7 — Мониторинг и логирование

## US-7.1 — Метрики Prometheus
**User Story:**  
Я как инженер хочу видеть метрики сервисов чтобы контролировать SLA

**Priority:** Medium

**Acceptance Criteria:**
- Экспорт request_latency, error_rate, webhook_processing_time
- Дашборды в Grafana

## US-7.2 — Логирование в Loki
**User Story:**  
Я как инженер хочу искать логи всех сервисов в одном месте чтобы быстрее диагностировать проблемы

**Priority:** Medium

**Acceptance Criteria:**
- Все логи централизованы
- Поддержка trace_id

# Epic 8 — Multi-tenant

## US-8.1 — Изоляция tenant_id
**User Story:**  
Я как владелец SaaS хочу чтобы данные арендаторов были изолированы чтобы предотвратить утечки данных

**Priority:** High

**Acceptance Criteria:**
- Все запросы фильтруются по tenant_id
- Тесты демонстрируют невозможность доступа между tenant'ами

## US-8.2 — RBAC per tenant
**User Story:**  
Я как админ хочу управлять ролями внутри своего tenant чтобы разграничивать доступ

**Priority:** Medium

**Acceptance Criteria:**
- Роли действуют только в пределах tenant
- Проверка прав на всех эндпоинтах

# Epic 9 — DevOps

## US-9.1 — CI pipeline
**User Story:**  
Я как разработчик хочу чтобы PR проходил автоматические тесты чтобы защищать качество кода

**Priority:** Medium

**Acceptance Criteria:**
- Unit + integration tests запускаются на PR
- Merge запрещён при провале

## US-9.2 — Canary/Blue-Green deploy
**User Story:**  
Я как DevOps хочу безопасно раскатывать обновления чтобы снизить риски при релизе

**Priority:** Medium

**Acceptance Criteria:**
- Поддержка Canary трафика
- Автоматический rollback

# Epic 10 — QA

## US-10.1 — Нагрузочное тестирование
**User Story:**  
Я как владелец системы хочу чтобы платформа выдерживала 1000 RPS чтобы поддерживать рост нагрузки

**Priority:** Low

**Acceptance Criteria:**
- Средний response time < 300 ms при 1000 RPS

## US-10.2 — Тест идемпотентности вебхуков
**User Story:**  
Я как QA хочу проверять повторные вебхуки чтобы система не выполняла действия дважды

**Priority:** Medium

**Acceptance Criteria:**
- Повторный webhook с тем же idempotency key не вызывает дублирующих операций
