# 1. Введение

## 1.1 Назначение документа
Документ описывает системные, функциональные и нефункциональные требования к платформе подписочного биллинга. Он предназначен для команды разработки, тестирования и эксплуатации, чтобы обеспечить:
- Полный жизненный цикл подписок
- Автоматические продления и обработку платежей
- Возвраты и интеграцию с внешними провайдерами
- Масштабируемость и стабильность при нагрузке >1000 RPS

## 1.2 Область применения системы
Система предназначена для:
- Управления подписками и тарифными планами
- Обработки платежей, возвратов и retry
- Интеграции с внешними платёжными системами (PayPal, Stripe, CUSTOM)
- Обеспечения UI для клиентов (Кабинет клиента) и администраторов (Кабинет администратора)
- Логирования, мониторинга и оповещений
- Масштабируемости и отказоустойчивости на основе брокера сообщений (Kafka)

## 1.3 Словарь терминов
- Subscription - подписка
- Plan - тарифный план
- Customer - клиент
- Payment - платеж
- Refund - возврат
- Provider - платёжный провайдер
- Webhook - уведомление от внешнего сервиса
- Tenant - арендатора / клиент multi-tenant
- RPS - запросов в секунду
- Retry - повторная попытка операции
- API - интерфейс взаимодействия

## 1.4 Ссылки
- [PCI DSS — Data Security Standard](https://www.pcisecuritystandards.org/standards/pci-dss/)  
- [OAuth 2.0 — The Authorization Framework (RFC 6749)](https://datatracker.ietf.org/doc/html/rfc6749)  
- [OAuth 2.0 Overview](https://oauth.net/2/)  
- [Kafka — документация Apache Kafka](https://kafka.apache.org/documentation/)  
- [Prometheus — Monitoring system & time series database](https://prometheus.io/)  
- [Grafana — Open source analytics & monitoring](https://grafana.com/)  
- [Loki — Logs aggregation system from Grafana Labs](https://grafana.com/oss/loki/)

## 1.5 Обзор документа
Документ описывает:
- Общие требования и функции системы
- Типы пользователей и сценарии использования
- Функциональные и нефункциональные требования
- Архитектуру, API и Kafka-интерфейсы
- План внедрения и интеграции

# 2. Общее описание

## 2.1 Контекст системы
Система представляет собой распределённую платформу подписочного биллинга с:
- Микросервисной архитектурой
- Асинхронным взаимодействием через Apache Kafka
- REST API для B2B интеграций
- Веб-интерфейсами для B2C клиентов и администраторов
- Интеграцией с внешними платёжными провайдерами
- Поддержкой мониторинга, логирования и алертинга

## 2.2 Высокоуровневые функции
- Управление подписками: создание, продление, приостановка, отмена
- Поддержка тарифных планов и триалов
- Автоматическое продление подписок
- Автоматический retry при ошибках списаний
- Обработка возвратов
- Приём и обработка Webhook событий от внешних провайдеров
- Кабинеты пользователей и администраторов
- Логирование и метрики всех ключевых операций
- Масштабируемость и отказоустойчивость

## 2.3 Типы пользователей
- B2C клиент - управляет своими подписками
- B2B партнёр - интегрируется через API
- Администратор - управляет пользователями, тарифами, мониторингом
- Интегратор / провайдер - взаимодействует через вебхуки и адаптеры

## 2.4 Среда эксплуатации
- Облачная инфраструктура
- PostgreSQL, Redis, S3
- Kafka как основной механизм коммуникации
- Kubernetes / контейнерная среда
- Поддержка multi-tenant
- Нагрузка >1000 RPS

## 2.5 Ограничения
- Идемпотентность всех API и Kafka-событий
- Время обработки вебхука ≤ 3 секунд
- Соответствие PCI DSS
- Ограничения форматов вебхуков от провайдеров

## 2.6 Допущения и зависимости
- Все провайдеры используют вебхуки
- Клиентские и административные UI используют REST API
- Асинхронная логика работает через Kafka
- Система развёрнута в облаке и масштабируется горизонтально

# 3. Функциональные требования
## 3.1 Управление подписками (Subscriptions Management)
Система должна предоставлять возможности:
### 3.1.1 Создание подписки
- Создание подписки для указанного клиента и тарифного плана
- Поддержка бесплатных пробных периодов (trial)
- Валидация корректности данных: активность клиента, валидность плана, отсутствие конфликтующих подписок
- Инициация первого платежа (если не trial)
- Генерация события `subscriptions.created` в Kafka

### 3.1.2 Просмотр состояния подписки
- Получение текущего статуса: _active_, _past_due_, _cancelled_, _paused_, _expired_
- Просмотр истории платежей и инвойсов
- Просмотр даты следующего списания

### 3.1.3 Обновление подписки
- Изменение тарифного плана
- Пересчёт следующего платежа согласно правилам proration
- Генерация события `subscriptions.updated`

### 3.1.4 Приостановка и возобновление
- Возможность временно остановить списания
- Возобновление с сохранением исходного периода
- Генерация событий `subscriptions.paused` / `subscriptions.resumed`

### 3.1.5 Отмена подписки
- Возможность отмены в конце периода
- Возможность немедленной отмены
- Генерация события `subscriptions.cancelled`

### 3.1.6 Автоматическое продление
- Автоматическое списание в дату `next_payment`
- Создание нового инвойса
- Продление периода подписки
- Генерация события `subscriptions.renewed`

## 3.2 Управление тарифами (Plans Management)
Система предоставляет:

### 3.2.1 Управление планами
- Создание тарифного плана: цена, интервал (month, year), описание
- Обновление параметров плана
- Деактивация/архивация плана (нельзя назначить новые, но действующие остаются)

### 3.2.2 Ограничения и правила
- Поддержка trial-периодов
- Поддержка ограничений: максимум подписок, лимиты, квоты
- Возможность связывать несколько подписок одного клиента в рамках одного бизнеса

## 3.3 Управление клиентами (Customers Management)

### 3.3.1 Регистрация клиента
- Создание записи клиента в рамках конкретного Business/Tenant
- Хранение email, метаданных, timezone

### 3.3.2 Обновление профиля
- Изменение email
- Изменение привязанных методов оплаты (через provider token)

### 3.3.3 Просмотр истории
- История платежей
- История подписок

## 3.4 Платежи и инвойсы (Payments & Invoices)

### 3.4.1 Создание инвойса
- Автоматически при продлении подписки
- Вручную через API администратора
- Генерация события `invoices.created`

### 3.4.2 Списания (Payments)
- Инициирование платежа через внешнего провайдера (Stripe, PayPal, Custom)
- Обработка ответа провайдера
- Обновление статуса: `pending → succeeded / failed`
- Генерация событий `payments.requested`, `payments.succeeded`, `payments.failed`

### 3.4.3 Retry неуспешных платежей
- Автоматический retry с экспоненциальными интервалами
- Лимиты количества повторов
- Генерация события `payments.retry.requested`

### 3.4.4 Возвраты (Refunds)
- Полный или частичный возврат
- Обновление статуса транзакции
- Генерация события `payments.refunded`

## 3.5 Webhooks (Provider Callbacks)

### 3.5.1 Получение вебхуков
- Приём событий от провайдеров:
    - _payment.succeeded_
    - _payment.failed_
    - _chargeback_
    - _refund.succeeded_

### 3.5.2 Требования
- Валидация подписи провайдера
- Лимит обработки ≤ 3 сек
- Идемпотентность (1 вебхук → 1 действие)
- Генерация события `webhooks.received`

## 3.6 Административная панель

### 3.6.1 Управление бизнесами (Tenants)
- Создание/удаление бизнесов
- Управление ролями и пользователями

### 3.6.2 Управление тарифами
- CRUD операций планов
- Автоматическое обновление всех зависимых сущностей

### 3.6.3 Мониторинг
- Просмотр активных подписок
- Просмотр ошибок и retry
- Просмотр статуса платежей и внешних интеграций

## 3.7 Клиентский кабинет (Customer Portal)

### 3.7.1 Функциональность клиента
- Просмотр активных подписок
- Просмотр предстоящих платежей
- Обновление метода оплаты
- Отмена подписки
- Просмотр истории транзакций

## 3.8 Логирование, метрики, мониторинг

### 3.8.1 Метрики
- Успех/ошибка платежей
- Время обработки вебхуков
- Количество retry
- Количество активных подписок

### 3.8.2 Логи
- Все изменения статусов подписок
- Все события жизненного цикла платежа
- Ошибки интеграции провайдеров

## 3.9 Multi-Tenant функциональность

### 3.9.1 Изоляция данных
- Tenant A полностью изолирован от Tenant B
- Никакие API-ключи не дают доступа к чужим данным

### 3.9.2 Политики доступа
- RBAC per tenant
- Access token привязан к конкретному Business

# 4. Внешние интерфейсы

## 4.1 UI требования
- REST API для B2B
- Веб-интерфейсы для клиентов и администраторов
- Адаптивная верстка
- Поддержка всех основных браузеров

## 4.2 External REST API (Commands → Kafka Events)

REST API используется только для внешних клиентов (UI, B2B).  
Каждый REST-вызов создаёт Kafka событие, а все внутренние сервисы работают асинхронно.

Документация:  
- [4. API Specification](https://github.com/maticht/RedCore-Subscription-Billing-Platform/blob/main/4.%20API%20Specification.md)
- [5. Kafka Topics Specification](https://github.com/maticht/RedCore-Subscription-Billing-Platform/blob/main/5.%20Kafka%20Topics%20Specification.md)
### 4.2.1 Subscriptions API
- **POST /subscriptions**  
    Создание подписки (синхронная операция) 
    - Валидация данных 
    - Создание записи подписки в БД 
    - Инициация первого платежа через Payment Service 
    - Возврат результата клиенту
	После успешного создания порождает событие **`subscriptions.created`** (асинхронно, не блокирует ответ клиенту)
- **GET /subscriptions/{id}**  
    Получение состояния
- **PUT /subscriptions/{id}**  
    Обновление подписки  
    Порождает событие **`subscriptions.updated`**
- **DELETE /subscriptions/{id}**  
    Отмена подписки  
    Порождает событие **`subscriptions.cancelled`** 

### 4.2.2 Payments API
- **POST /payments**  
    Запросить платёж вручную  
    Порождает событие **`payments.requested`**
- **GET /payments/{id}**  
    Получение статуса
- **GET /payments**
    Получить список всех платежей
- **POST /payments/{id}/retry**  
    Ручной retry  
    Порождает событие **`payments.retry.requested`**

### 4.2.3 Webhooks API (от провайдеров)
- **POST /webhooks/{provider}**  
    Приём вебхука  
    Порождает событие **`webhooks.received
## 4.3 Hardware Interfaces
- Облачные серверы
- Балансировщики нагрузки

## 4.4 Software Interfaces
- PostgreSQL, Redis, S3
- Prometheus, Grafana, Loki
- Apache Kafka (основной транспорт событий)

## 4.5 Communications Interfaces
- HTTPS
- TLS 1.2+
- OAuth2 + JWT
- Webhooks от платёжных провайдеров

# 5. Нефункциональные требования

## 5.1 Производительность
- Среднее время ответа API ≤ 300 мс
- Поддержка >1000 RPS
- Вебхуки: 500–800 событий в секунду

## 5.2 Безопасность
- OAuth2 и RBAC
- Соответствие PCI DSS
- HTTPS и TLS 1.2+
- Логирование всех критических событий

## 5.3 Надёжность
- Идемпотентность всех операций
- Retry механизм для failed payments
- Доступность 99.9%
- Автоматическое масштабирование и отказоустойчивость

## 5.4 Поддерживаемость
- Микросервисная архитектура
- Документированное API
- Логирование и мониторинг для диагностики

## 5.5 Масштабируемость
- Горизонтальное масштабирование сервисов
- Брокер сообщений для асинхронной обработки и очередей retry
- Поддержка тысяч подписок и клиентов

# 6. Прочие требования
- Multi-tenant поддержка B2B клиентов
- Настройка уведомлений и алертов
- Дашборды для администраторов
- Внешние интеграции через адаптеры

# 7. Модель данных
Ниже представлена ER-диаграмма, описывающая доменную модель платформы подписочного биллинга. Диаграмма фиксирует ключевые сущности (Business, Customer, Plan, Subscription, Invoice, Payment) и их связи, обеспечивая понимание структуры данных и потоков, связанных с жизненным циклом подписки и платежей. Модель служит основой для проектирования API, хранения данных и процессов биллинга.

[ERD.drawio.png](https://github.com/maticht/RedCore-Subscription-Billing-Platform/blob/main/imgs/ERD.drawio.png)

## 8. План тестирования и обеспечение качества (QA)

### 8.1 Стратегия тестирования

- ##### Unit Testing (Модульное тестирование)
    - Цель: Проверить **изолированную бизнес-логику** на уровне отдельных функций, методов или классов
    - Фокус: Расчеты (например, расчет скидки), валидация данных (например, валидация даты), работа с небольшими блоками кода
    - Ответственный: Разработка
    
- ##### Integration Testing (Интеграционное тестирование)
    - Цель: Проверить корректность **взаимодействия** между различными модулями или сервисами
    - Фокус: Взаимодействие микросервисов (Subscription Service и Payment Service), а также внешняя интеграция (Provider Adapters) с заглушками внешних систем
    - Ответственный: Разработка, QA
    
- ##### End-to-End (E2E) Testing (Сквозное тестирование)
    - Цель: Проверить весь сквозной бизнес-процесс от начала до конца, имитируя действия реального пользователя
    - Фокус: Полный сценарий, например: создание подписки через UI $\rightarrow$ инициирование списания $\rightarrow$ обработка вебхука
    - Ответственный: QA
    
- ##### Non-Functional Testing (Нефункциональное тестирование)
    - Цель: Проверить, что система соответствует требованиям качества и ограничениям, описанным в разделе 5 (Производительность, Безопасность, Надежность)
    - Фокус: Нагрузочное тестирование (1000+ RPS), тестирование отказоустойчивости (Failover), тестирование безопасности (PCI DSS), тестирование изоляции данных (Multi-tenant)
    - Ответственный: QA, DevOps
### 8.2 Виды тестирования

#### 8.2.1 Тестирование производительности (Performance Testing)
- Load Testing (Нагрузочное): Подтвердить способность системы обрабатывать заявленную нагрузку >1000 RPS при среднем времени ответа < 300 мс
- Stress Testing (Стрессовое): Определить точку отказа системы при экстремальной нагрузке (например, при 1500 RPS) для оценки пределов масштабируемости

#### 8.2.2 Тестирование отказоустойчивости (Reliability Testing)
- Failover Testing: Проверка корректности работы механизма Retry и Kafka-топиков при падении одного из сервисов (например, Payment Service). Убедиться, что события не теряются
- Idempotency Testing: Проверка, что повторное получение одного и того же Kafka-сообщения (особенно для платежей, возвратов и вебхуков) не приводит к дублированию транзакций в базе данных

#### 8.2.3 Тестирование безопасности (Security Testing)
- Authentication/Authorization Testing (Тестирование прав): Подтвердить, что B2C Клиент не может получить доступ к данным других клиентов или тарифам Администратора (RBAC)
- PCI DSS Compliance Check: Проверка, что все данные платежных карт обрабатываются вне системы (внешними провайдерами) и что внутренние логи не содержат конфиденциальной платежной информации
- Input Validation: Проверка защиты от XSS/SQL Injection в API Gateway и всех формах UI

#### 8.2.4 Тестирование Multi-tenant
- Data Isolation Testing: Проверка, что Tenant A не имеет никакого доступа к данным (подписки, клиенты, платежи) Tenant B (критически важно для `Customer Service`)